*following step2.sas from karminderclearlog using "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/loglib/mtcs0104.log", replace textset mem 300muse "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/smdat01", replace* recreating lubin's cohort	*death	gen died = 0		replace died = 1 if ( vstat == 4 | vstat == 5)	* durations and outcome summaries  	gen dur_emp = (termdate - hiredate)/365.25  	gen dur_fu  = (dlo - start_fu)/365.25  	gen cancer=0  	  	replace cancer = 1 if 140<=icd3 & icd3<=209  	gen respcan=0  	 	replace respcan = 1 if 160 <= icd3 & icd3 <=164  	gen age_entry=(start_fu-dob)/365.25  		replace age_entry=floor(age_entry)  	gen age_exit=(dlo-dob)/365.25  		replace age_exit=floor(age_exit)compress  		save "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/lubin_ind", replace  		  		use "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/smdat02", replace 	 	gen d_lubin = 0.29*aslt+0.58*asmd+11.3*ashi  	label var d_lubin  "DERIVED: 0.29*aslt+0.58*asmd+11.3*ashi"compresssave "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/lubin_exp", replace*re-creating J. Robins' datause "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/smdat01", replace	gen died = 0		replace died = 1 if dlo <= date("31dec1977", "DMY") & ( vstat == 4 | vstat == 5)	replace dlo = date("31dec1977", "DMY") if dlo > date("31dec1977", "DMY")	replace termdate = date("01jan1978", "DMY") if termdate > date("31dec1977", "DMY")	keep if hiredate > date("01jan1935", "DMY")		tab died		* durations and outcome summaries  	gen dur_emp = (termdate - hiredate)/365.25  	gen dur_fu  = (dlo - start_fu)/365.25  	gen cancer=0  	  	replace cancer = 1 if 140<=icd3 & icd3<=209  	gen respcan=0  	 	replace respcan = 1 if 160 <= icd3 & icd3 <=164  	gen age_entry=(start_fu-dob)/365.25  		replace age_entry=floor(age_entry)  	gen age_exit=(dlo-dob)/365.25  		replace age_exit=floor(age_exit)compresssave "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/robins_ind", replace	tab1 died cancer respcan		* get total number of individuals, by year	preserve		gen start_year 	= year(start_fu)		gen end_year	= year(dlo)				qui su start_year			local firstyear = r(min)		qui su end_year			local lastyear = r(max)		di `firstyear' " " `lastyear'			forvalues yr = `firstyear' / `lastyear' {			gen inyr_`yr' = (start_year < = `yr' & end_year >= `yr')		}		*list start_year end_year inyr* in 1		forvalues yr = `firstyear' / `lastyear' {			egen suminyr_`yr' = sum(inyr_`yr')		}		list suminyr* in 1				*deaths in year		forvalues yr = `firstyear' / `lastyear' {			gen deadinyr_`yr' = (end_year == `yr' & died==1)		}		list start_year end_year died deadinyr* in 10		forvalues yr = `firstyear' / `lastyear' {			egen sumdeadinyr_`yr' = sum(deadinyr_`yr')		}		list sumdeadinyr* in 1		keep if _n==1 		keep sumin* sumdead*		tempfile yearly		save `yearly'	restore*create robins' exposure datause "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/smdat02", replace 	gen d_lubin = 0.29*aslt+0.58*asmd+11.3*ashi  	label var d_lubin  "DERIVED: 0.29*aslt+0.58*asmd+11.3*ashi"compress  	save "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/robins_exp", replace  	use "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/robins_ind", replacemerge smid using "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/smdat02", sort uniqmastertempfile exposure	save `exposure'	 	gen d_lubin = 0.29*aslt+0.58*asmd+11.3*ashi 	gen d_lubin2 = 2*aslt+5.5*asmd+10*ashi 	gen delta  = d_lubin2 - cumas 	gen d_feldstein = 0.38*aslt+7.03*asmd+61.99*ashi 	  	label var d_lubin  "DERIVED: 0.29*aslt+0.58*asmd+11.3*ashi"  	label var d_lubin2  "DERIVED: 2*aslt+5.5*asmd+10*ashi"  	label var d_feldstein  "DERIVED: 0.38*aslt+7.03*asmd+61.99*ashi"  	  	su d_lubin, detail  	  	regress delta aslt asmd ashi  	  	preserve			  	*line cumas d_lubin2	  	keep  if cumas !=0	  	sort smid age	  	by smid: keep if _n == 1	  	*scatter cumas d_lubin2		gen tmp_lubin = d_lubin		gen tmp_cumas = cumas		replace d_lubin = round(tmp_lubin, 0.1)		replace cumas = round(tmp_cumas, 0.1)		su cumas d_lubin, detail				keep if d_lubin == cumas		tempfile exposure5		save `exposure5'		list smid age maxas aslt asmd cumas d_lubin in 1/200	restore		use `exposure', replace	list smid died age cumas in 1/200		drop if age < age_entry	drop if age > (dlo-dob)/365.25	gen y = 0		gsort + smid - age	by smid: replace y = died if _n == 1	gsort + smid + age		gen t = 2-y			tab age y		stset age, failure(y)		*didn't run in sas - need to fix	stcox cumas, strata(age) exactp /* hope exactp does same thing as discrete option from SAS */	use `exposure', replace	gen lag_cumas = 0	sort smid age	by smid: replace lag_cumas = cumas[_n-1]	by smid: replace lag_cumas = 0 if _n == 1	gen as = cumas - lag_cumas	label var as "annual arsenic exposure"		list smid age cumas lag_cumas as in 1/200		drop if age < age_entry	gen year = (age-age_entry)+year(start_fu)		keep if year <= 1977	preserve		gen start_year 	= year(start_fu)		gen end_year	= year(dlo)		qui su start_year			local firstyear = r(min)		qui su end_year			local lastyear = r(max)		di `firstyear' " " `lastyear'		forvalues yr = `firstyear' / `lastyear' {			qui egen tmp_pmedian_`yr' = pctile(as) if year == `yr', p(50)			qui egen tmp_q3_`yr' = pctile(as) if year == `yr', p(75)			qui egen tmp_per90_`yr' = pctile(as) if year == `yr', p(90)								}		keep in 1/1000		forvalues yr = `firstyear' / `lastyear' {			qui egen pmedian_`yr' = max(tmp_pmedian_`yr')			qui egen q3_`yr' 	  = max(tmp_q3_`yr')			qui egen per90_`yr'   = max(tmp_per90_`yr')		}		drop tmp_*		list year q3* per90* pmedian* in 10		keep q3* per90* pmedian*		keep in 1		tempfile yearly2		save `yearly2'	restore		use `yearly', replace	merge using `yearly2'			gen i=1			reshape long pmedian_ q3_ per90_ suminyr_ sumdeadinyr_, i(i) j(year)		drop _merge i		rename suminyr_ totn		rename sumdeadinyr_ deaths		rename pmedian_ median		rename q3_ q3		rename per90_ per90		list in 1/10save "/Users/akeil/School/Outside Projects/CopperArsenic/Descriptive/datlib/yearly_sums", replace			twoway (line median year) (line q3 year) (line per90 year)		gen logn = ln(totn)	xi: poisson deaths i.year, offset(logn)	predict deathrate, ir		line deathrate year	log close